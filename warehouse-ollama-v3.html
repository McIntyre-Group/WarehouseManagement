<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse AI Assistant v3.0</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-message {
            max-width: 80%;
            margin: 0.5rem 0;
            padding: 0.75rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        
        .ai-message {
            background-color: #f1f5f9;
            color: #334155;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        
        .typing-indicator {
            display: flex;
            padding: 1rem;
            background-color: #f1f5f9;
            border-radius: 1rem;
            margin: 0.5rem 0;
            max-width: 80px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #64748b;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        @media print {
            @page {
                margin: 0.5in;
                size: letter;
            }
            
            * {
                visibility: hidden;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #pickList,
            #pickList * {
                visibility: visible;
            }
            
            #pickList {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                page-break-inside: avoid;
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body class="bg-base-100 min-h-screen">
    <div class="container mx-auto p-6 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary mb-2">ü§ñ Warehouse AI Assistant</h1>
            <p class="text-base-content/70">Powered by Ollama on your Proxmox server</p>
            
            <!-- Server Status -->
            <div class="mt-4">
                <div id="serverStatus" class="badge badge-error">Server Offline</div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status" class="hidden"></div>

        <!-- AI Chat Interface -->
        <div class="card bg-base-200 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">
                    <span>ü§ñ</span>
                    AI Assistant Chat
                </h2>
                
                <!-- Server Configuration -->
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text font-medium">Ollama Server URL</span>
                    </label>
                    <input type="text" id="ollamaUrl" value="https://your-domain.com/ollama" placeholder="https://your-domain.com/ollama" class="input input-bordered w-full" />
                    <label class="label">
                        <span class="label-text-alt">Use HTTPS proxy to avoid CSP issues</span>
                    </label>
                </div>
                
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text font-medium">Model</span>
                    </label>
                    <select id="ollamaModel" class="select select-bordered w-full">
                        <option value="llama3.1:8b">Llama 3.1 8B</option>
                        <option value="llama3.1:70b">Llama 3.1 70B</option>
                        <option value="llama2:7b">Llama 2 7B</option>
                        <option value="codellama:7b">Code Llama 7B</option>
                        <option value="mistral:7b">Mistral 7B</option>
                        <option value="phi3:3.8b">Phi-3 3.8B</option>
                    </select>
                </div>
                
                <button class="btn btn-outline btn-sm mb-4" onclick="testConnection()">Test Connection</button>
                
                <!-- Chat Messages -->
                <div id="chatMessages" class="min-h-96 max-h-96 overflow-y-auto border border-base-300 rounded-lg p-4 mb-4 bg-base-100">
                    <div class="ai-message chat-message">
                        üëã Hello! I'm your warehouse AI assistant. I can help you with:
                        <ul class="list-disc list-inside mt-2">
                            <li>Analyzing inventory data</li>
                            <li>Creating shipment summaries</li>
                            <li>Generating reports</li>
                            <li>Finding license plates</li>
                            <li>Warehouse optimization suggestions</li>
                        </ul>
                        Ask me anything about your warehouse operations!
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Ask me about your warehouse data..." class="input input-bordered flex-1" onkeypress="handleChatKeyPress(event)" />
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="grid gap-4">
            <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-shadow cursor-pointer" onclick="showShipmentWorkflow()">
                <div class="card-body">
                    <div class="flex items-center gap-4">
                        <div class="avatar placeholder">
                            <div class="bg-primary text-primary-content rounded-full w-12">
                                <span class="text-xl">üì¶</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="card-title">Create New Shipment</h3>
                            <p class="text-base-content/70">Generate pick lists and manage outbound shipments</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-shadow cursor-pointer" onclick="showReportsWorkflow()">
                <div class="card-body">
                    <div class="flex items-center gap-4">
                        <div class="avatar placeholder">
                            <div class="bg-accent text-accent-content rounded-full w-12">
                                <span class="text-xl">üìä</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="card-title">Generate Reports</h3>
                            <p class="text-base-content/70">Create warehouse analytics and performance reports</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-shadow cursor-pointer" onclick="showDataAnalysis()">
                <div class="card-body">
                    <div class="flex items-center gap-4">
                        <div class="avatar placeholder">
                            <div class="bg-info text-info-content rounded-full w-12">
                                <span class="text-xl">üîç</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="card-title">AI Data Analysis</h3>
                            <p class="text-base-content/70">Get AI insights into your warehouse data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipment Workflow (simplified for demo) -->
        <div id="shipmentWorkflow" class="hidden">
            <button class="btn btn-outline btn-sm mb-6" onclick="showMainMenu()">‚Üê Back to Main Menu</button>
            <div class="card bg-base-200 shadow-lg">
                <div class="card-body">
                    <h2 class="card-title">Shipment Management</h2>
                    <p>Shipment functionality - enhanced with AI assistance</p>
                </div>
            </div>
        </div>

        <!-- Reports Workflow (simplified for demo) -->
        <div id="reportsWorkflow" class="hidden">
            <button class="btn btn-outline btn-sm mb-6" onclick="showMainMenu()">‚Üê Back to Main Menu</button>
            <div class="card bg-base-200 shadow-lg">
                <div class="card-body">
                    <h2 class="card-title">AI-Enhanced Reports</h2>
                    <p>Report generation with AI insights and analysis</p>
                </div>
            </div>
        </div>

        <!-- Data Analysis -->
        <div id="dataAnalysis" class="hidden">
            <button class="btn btn-outline btn-sm mb-6" onclick="showMainMenu()">‚Üê Back to Main Menu</button>
            <div class="card bg-base-200 shadow-lg">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <span>üîç</span>
                        AI Data Analysis
                    </h2>
                    <p class="text-base-content/70 mb-6">Get AI insights into your warehouse data</p>
                    
                    <button class="btn btn-primary w-full mb-4" onclick="analyzeCurrentData()">
                        ü§ñ Analyze Current Excel Data
                    </button>
                    
                    <div id="analysisResults" class="hidden">
                        <div class="alert alert-info mb-4">
                            <span>üìä Analysis Complete - Check the chat above for detailed insights!</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let currentModel = 'llama3.1:8b';

        // Initialize Office Add-in
        Office.onReady((info) => {
            if (info.host === Office.HostType.Excel) {
                showStatus('Warehouse AI Assistant v3.0 loaded successfully!', 'success');
                testConnection();
            }
        });

        // Navigation Functions
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('shipmentWorkflow').classList.add('hidden');
            document.getElementById('reportsWorkflow').classList.add('hidden');
            document.getElementById('dataAnalysis').classList.add('hidden');
        }

        function showShipmentWorkflow() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('shipmentWorkflow').classList.remove('hidden');
        }

        function showReportsWorkflow() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('reportsWorkflow').classList.remove('hidden');
        }

        function showDataAnalysis() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('dataAnalysis').classList.remove('hidden');
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            let alertClass = 'alert-info';
            
            if (type === 'success') alertClass = 'alert-success';
            if (type === 'error') alertClass = 'alert-error';
            
            statusDiv.className = `alert ${alertClass} mb-6`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // AI Chat Functions
        async function testConnection() {
            const url = document.getElementById('ollamaUrl').value;
            const statusDiv = document.getElementById('serverStatus');
            
            try {
                // Try a simple test request
                const response = await fetch(`${url}/api/tags`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    statusDiv.className = 'badge badge-success';
                    statusDiv.textContent = 'Server Online';
                    isConnected = true;
                    showStatus('‚úÖ Successfully connected to Ollama server!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusDiv.className = 'badge badge-error';
                statusDiv.textContent = 'Server Offline';
                isConnected = false;
                console.error('Connection failed:', error);
                showStatus('‚ùå Connection failed: ' + error.message, 'error');
                
                // Show helpful error message
                addMessageToChat(`‚ö†Ô∏è **Connection failed**: ${error.message}

**To fix this issue:**

1. **Set up an HTTPS proxy** - Office Add-ins require HTTPS connections
2. **Try ngrok**: \`ngrok http 11434\` then use the HTTPS URL
3. **Use Cloudflare Tunnel**: \`cloudflared tunnel --url http://localhost:11434\`
4. **Configure reverse proxy** with SSL certificate

**Example with ngrok:**
\`\`\`bash
# Install ngrok, then run:
ngrok http 11434
# Use the https://xxx.ngrok.io URL above
\`\`\``, 'ai');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const response = await callOllama(message);
                hideTypingIndicator();
                addMessageToChat(response, 'ai');
            } catch (error) {
                hideTypingIndicator();
                addMessageToChat(`‚ùå Error: ${error.message}`, 'ai');
            }
        }

        async function callOllama(prompt) {
            const url = document.getElementById('ollamaUrl').value;
            const model = document.getElementById('ollamaModel').value;
            
            if (!isConnected) {
                throw new Error('Not connected to Ollama server. Please check connection.');
            }
            
            const response = await fetch(`${url}/api/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: model,
                    prompt: prompt,
                    stream: false,
                    system: "You are a helpful warehouse management AI assistant. You help with inventory management, shipment tracking, data analysis, and operational optimization. Be concise but thorough in your responses."
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.response;
        }

        function addMessageToChat(message, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `${type}-message chat-message`;
            messageDiv.innerHTML = formatMessage(message);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessage(message) {
            // Basic markdown-like formatting
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code class="bg-base-300 px-1 rounded">$1</code>')
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-base-300 p-2 rounded mt-2 mb-2 overflow-x-auto"><code>$1</code></pre>')
                .replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Data Analysis Functions
        async function analyzeCurrentData() {
            try {
                showStatus('üîç Analyzing Excel data...', 'info');
                
                // Get data from Excel
                const data = await getExcelData();
                
                // Prepare data summary for AI
                const summary = `Please analyze this warehouse data and provide insights:

**Total Records**: ${data.length}
**Sample Data**: ${JSON.stringify(data.slice(0, 5), null, 2)}

Please provide:
1. Key statistics and trends
2. Potential issues or bottlenecks
3. Optimization recommendations
4. Inventory insights

Focus on actionable warehouse management advice.`;

                // Send to AI
                showTypingIndicator();
                const analysis = await callOllama(summary);
                hideTypingIndicator();
                
                // Show results
                addMessageToChat(`üìä **Excel Data Analysis Complete**\n\n${analysis}`, 'ai');
                document.getElementById('analysisResults').classList.remove('hidden');
                showStatus('‚úÖ Analysis complete! Check the chat for insights.', 'success');
                
            } catch (error) {
                hideTypingIndicator();
                showStatus('Error analyzing data: ' + error.message, 'error');
                addMessageToChat(`‚ùå Analysis failed: ${error.message}`, 'ai');
            }
        }

        async function getExcelData() {
            return new Promise((resolve, reject) => {
                Excel.run(async (context) => {
                    try {
                        const worksheets = context.workbook.worksheets;
                        worksheets.load('items/name');
                        await context.sync();

                        const allData = [];
                        
                        // Get data from first available worksheet
                        for (const worksheet of worksheets.items) {
                            if (!worksheet.name.includes('Lookup') && 
                                !worksheet.name.includes('PIVOT') && 
                                !worksheet.name.includes('TOTAL DATA')) {
                                
                                const usedRange = worksheet.getUsedRange();
                                if (usedRange) {
                                    usedRange.load('values');
                                    await context.sync();
                                    
                                    const values = usedRange.values;
                                    const headers = values[0];
                                    
                                    for (let i = 1; i < Math.min(values.length, 100); i++) { // Limit to 100 rows for analysis
                                        const row = {};
                                        headers.forEach((header, index) => {
                                            row[header] = values[i][index];
                                        });
                                        allData.push(row);
                                    }
                                    break; // Just analyze first sheet for now
                                }
                            }
                        }
                        
                        resolve(allData);
                    } catch (error) {
                        reject(error);
                    }
                }).catch(reject);
            });
        }
    </script>
</body>
</html>
